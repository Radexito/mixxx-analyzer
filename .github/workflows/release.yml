name: Release

on:
  push:
    branches: [main]

jobs:
  # ── Shared release tag ────────────────────────────────────────────────────────
  setup:
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Generate release tag
        id: tag
        run: echo "tag=build-$(date -u +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

  # ── Linux x86_64 wheel ────────────────────────────────────────────────────────
  wheel-linux:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Build & test (Docker)
        run: |
          docker build -t mixxx-analyzer-build .
          docker run --rm mixxx-analyzer-build \
            bash -c "cd /src && bash tests/download_assets.sh && build/mixxx-analyzer-test"

      - name: Extract binary
        run: |
          id=$(docker create mixxx-analyzer-build)
          docker cp "$id":/src/build/mixxx-analyzer ./mixxx-analyzer
          docker rm "$id"
          chmod +x mixxx-analyzer

      - name: Bundle shared libs
        run: |
          sudo apt-get install -y patchelf
          bash scripts/bundle_linux.sh ./mixxx-analyzer python/mixxx_analyzer/bin/

      - name: Build wheel
        run: |
          pip install build
          cd python && python3 -m build --wheel

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-x86_64
          path: python/dist/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: binary-linux-x86_64
          path: mixxx-analyzer

  # ── macOS arm64 (Apple Silicon) ───────────────────────────────────────────────
  wheel-macos-arm64:
    needs: setup
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: brew install cmake ffmpeg libebur128

      - name: Build binary
        run: |
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF
          cmake --build build --parallel $(sysctl -n hw.logicalcpu)

      - name: Bundle dylibs + build wheel
        run: |
          cp build/mixxx-analyzer python/mixxx_analyzer/bin/
          chmod 755 python/mixxx_analyzer/bin/mixxx-analyzer
          pip install build delocate
          cd python
          python3 -m build --wheel
          delocate-wheel -w dist/repaired dist/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-macos-arm64
          path: python/dist/repaired/*.whl

  # ── macOS x86_64 (Intel) ─────────────────────────────────────────────────────
  wheel-macos-x86_64:
    needs: setup
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: brew install cmake ffmpeg libebur128

      - name: Build binary
        run: |
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF
          cmake --build build --parallel $(sysctl -n hw.logicalcpu)

      - name: Bundle dylibs + build wheel
        run: |
          cp build/mixxx-analyzer python/mixxx_analyzer/bin/
          chmod 755 python/mixxx_analyzer/bin/mixxx-analyzer
          pip install build delocate
          cd python
          python3 -m build --wheel
          delocate-wheel -w dist/repaired dist/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-macos-x86_64
          path: python/dist/repaired/*.whl

  # ── Windows x86_64 ───────────────────────────────────────────────────────────
  wheel-windows:
    needs: setup
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install vcpkg deps
        run: |
          vcpkg install ffmpeg:x64-windows libebur128:x64-windows
        env:
          VCPKG_DEFAULT_TRIPLET: x64-windows

      - name: Build binary
        shell: cmd
        run: |
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF ^
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ^
            -DVCPKG_TARGET_TRIPLET=x64-windows
          cmake --build build --config Release --parallel

      - name: Bundle DLLs
        shell: pwsh
        run: |
          # Add vcpkg bin to PATH so Find-Dll locates the DLLs
          $env:PATH = "C:\vcpkg\installed\x64-windows\bin;$env:PATH"
          New-Item -ItemType Directory -Force python/mixxx_analyzer/bin | Out-Null
          pwsh scripts/bundle_windows.ps1 `
            build/Release/mixxx-analyzer.exe `
            python/mixxx_analyzer/bin

      - name: Build wheel
        shell: pwsh
        run: |
          pip install build
          cd python
          python -m build --wheel

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-windows-x86_64
          path: python/dist/*.whl

  # ── Create GitHub release ─────────────────────────────────────────────────────
  create-release:
    needs: [setup, wheel-linux, wheel-macos-arm64, wheel-macos-x86_64, wheel-windows]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: "wheel-*"
          path: dist/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: binary-linux-x86_64
          path: dist/

      - name: Rename raw binary
        run: mv dist/mixxx-analyzer dist/mixxx-analyzer-linux-x86_64 && chmod +x dist/mixxx-analyzer-linux-x86_64

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag }}
          name: "mixxx-analyzer ${{ needs.setup.outputs.tag }}"
          body: |
            Automated release from commit ${{ github.sha }}

            ${{ github.event.head_commit.message }}

            ## Python wheels

            ```bash
            pip install mixxx_analyzer-*-<platform>.whl
            ```

            | File | Platform |
            |------|----------|
            | `*linux_x86_64.whl` | Linux x86_64 (Ubuntu 22.04+) |
            | `*macosx_*_arm64.whl` | macOS Apple Silicon |
            | `*macosx_*_x86_64.whl` | macOS Intel |
            | `*win_amd64.whl` | Windows x86_64 |

            All wheels are self-contained — no system dependencies required.
          files: dist/*
          fail_on_unmatched_files: true
