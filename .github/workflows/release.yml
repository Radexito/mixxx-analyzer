name: Release

on:
  push:
    branches: [main]

jobs:
  # ── Shared release tag ────────────────────────────────────────────────────────
  setup:
    runs-on: ubuntu-22.04
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Generate release tag
        id: tag
        run: echo "tag=build-$(date -u +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

  # ── Linux x86_64 ──────────────────────────────────────────────────────────────
  wheel-linux:
    needs: setup
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image & run tests
        run: |
          docker build -t mixxx-analyzer-build .
          docker run --rm mixxx-analyzer-build \
            bash -c "cd /src && bash tests/download_assets.sh && build/mixxx-analyzer-test"

      # auditwheel runs INSIDE Docker where all .so files are present so ldd resolves correctly.
      - name: Build manylinux wheel (inside Docker)
        run: |
          docker run --name wheel-run mixxx-analyzer-build bash -c "
            pip3 install build auditwheel patchelf --quiet &&
            mkdir -p /src/python/mixxx_analyzer/bin &&
            cp /src/build/mixxx-analyzer /src/python/mixxx_analyzer/bin/ &&
            chmod +x /src/python/mixxx_analyzer/bin/mixxx-analyzer &&
            cd /src/python &&
            python3 -m build --wheel &&
            auditwheel repair --plat manylinux_2_35_x86_64 dist/*.whl -w dist/repaired/"
          mkdir -p python/dist/repaired
          docker cp wheel-run:/src/python/dist/repaired/. python/dist/repaired/
          docker rm wheel-run

      # Standalone raw binary (bundled libs, RPATH=$ORIGIN) for direct download.
      - name: Build standalone binary tarball
        run: |
          docker run --name raw-run mixxx-analyzer-build bash -c "
            apt-get install -y patchelf -q &&
            mkdir -p /src/bundle &&
            bash /src/scripts/bundle_linux.sh /src/build/mixxx-analyzer /src/bundle"
          mkdir -p linux-bundle
          docker cp raw-run:/src/bundle/. linux-bundle/
          docker rm raw-run
          tar -czf mixxx-analyzer-linux-x86_64.tar.gz -C linux-bundle .

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-linux-x86_64
          path: python/dist/repaired/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: binary-linux-x86_64
          path: mixxx-analyzer-linux-x86_64.tar.gz

  # ── macOS arm64 (Apple Silicon) ───────────────────────────────────────────────
  wheel-macos-arm64:
    needs: setup
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: brew install cmake ffmpeg libebur128

      - name: Build binary
        run: |
          export PKG_CONFIG_PATH="$(brew --prefix)/lib/pkgconfig:${PKG_CONFIG_PATH:-}"
          cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF
          cmake --build build --parallel $(sysctl -n hw.logicalcpu)

      - name: Bundle dylibs, build wheel + standalone binary
        run: |
          cp build/mixxx-analyzer python/mixxx_analyzer/bin/
          chmod 755 python/mixxx_analyzer/bin/mixxx-analyzer
          python -m pip install build delocate

          # Standalone binary: bundle dylibs next to the executable
          python -m delocate.cmd.delocate_path \
            -L python/mixxx_analyzer/bin/ \
            python/mixxx_analyzer/bin/
          zip -j mixxx-analyzer-macos-arm64.zip python/mixxx_analyzer/bin/*

          # Wheel: build then repair (delocate-wheel re-bundles cleanly into .dylibs/)
          cd python
          MACOSX_DEPLOYMENT_TARGET=11.0 \
            _PYTHON_HOST_PLATFORM=macosx-11.0-arm64 \
            python -m build --wheel
          python -m delocate.cmd.delocate_wheel \
            --require-archs arm64 \
            -w dist/repaired dist/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-macos-arm64
          path: python/dist/repaired/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: binary-macos-arm64
          path: mixxx-analyzer-macos-arm64.zip

  # ── Windows x86_64 ───────────────────────────────────────────────────────────
  wheel-windows:
    needs: setup
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install libebur128 (vcpkg, cached)
        run: vcpkg install libebur128:x64-windows
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

      - name: Download pre-built FFmpeg (BtbN shared)
        shell: pwsh
        run: |
          $url = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-lgpl-shared.zip"
          Invoke-WebRequest -Uri $url -OutFile ffmpeg.zip -MaximumRetryCount 3
          Expand-Archive ffmpeg.zip -DestinationPath C:\ffmpeg-extract
          $dir = (Get-ChildItem -Directory C:\ffmpeg-extract)[0].FullName
          "FFMPEG_ROOT=$dir" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build binary
        shell: cmd
        run: |
          cmake -B build -S . ^
            -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF ^
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake ^
            -DVCPKG_TARGET_TRIPLET=x64-windows ^
            -DCMAKE_PREFIX_PATH="%FFMPEG_ROOT%;C:/vcpkg/installed/x64-windows"
          cmake --build build --config Release --parallel

      - name: Bundle DLLs
        shell: pwsh
        run: |
          $env:PATH = "C:\vcpkg\installed\x64-windows\bin;$env:FFMPEG_ROOT\bin;$env:PATH"
          New-Item -ItemType Directory -Force python/mixxx_analyzer/bin | Out-Null
          pwsh scripts/bundle_windows.ps1 `
            build/Release/mixxx-analyzer.exe `
            python/mixxx_analyzer/bin

      - name: Build wheel
        shell: pwsh
        run: |
          python -m pip install build
          cd python
          python -m build --wheel

      - name: Create standalone binary zip
        shell: pwsh
        run: |
          Compress-Archive -Path python/mixxx_analyzer/bin/* `
            -DestinationPath mixxx-analyzer-windows-x86_64.zip

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-windows-x86_64
          path: python/dist/*.whl

      - uses: actions/upload-artifact@v4
        with:
          name: binary-windows-x86_64
          path: mixxx-analyzer-windows-x86_64.zip

  # ── Create GitHub release ─────────────────────────────────────────────────────
  create-release:
    needs: [setup, wheel-linux, wheel-macos-arm64, wheel-windows]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: "wheel-*"
          path: dist/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          pattern: "binary-*"
          path: dist/
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.tag }}
          name: "mixxx-analyzer ${{ needs.setup.outputs.tag }}"
          body: |
            Automated release from commit ${{ github.sha }}

            ${{ github.event.head_commit.message }}

            ## Python wheels (self-contained, no system deps)

            ```bash
            pip install mixxx_analyzer-*-<platform>.whl
            ```

            | File | Platform |
            |------|----------|
            | `*manylinux_2_35_x86_64.whl` | Linux x86_64 (glibc ≥ 2.35 / Ubuntu 22.04+) |
            | `*macosx_11_0_arm64.whl` | macOS Apple Silicon |
            | `*win_amd64.whl` | Windows x86_64 |

            ## Standalone binaries (extract and run directly)

            | File | Platform |
            |------|----------|
            | `mixxx-analyzer-linux-x86_64.tar.gz` | Linux x86_64 |
            | `mixxx-analyzer-macos-arm64.zip` | macOS Apple Silicon |
            | `mixxx-analyzer-windows-x86_64.zip` | Windows x86_64 |
          files: dist/*
          fail_on_unmatched_files: true

  # ── Publish to PyPI ───────────────────────────────────────────────────────────
  publish-pypi:
    needs: [create-release, wheel-linux, wheel-macos-arm64, wheel-windows]
    runs-on: ubuntu-22.04
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "wheel-*"
          path: dist/
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
